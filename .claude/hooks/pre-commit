#!/bin/bash
# Pre-commit hook for MOAO11y Observability Framework
# Checks observability configuration and code quality before commit

set -e

echo "üîç Running pre-commit checks for MOAO11y..."

# Check 1: Verify application.yml files exist
echo "üìã Checking configuration files..."
if [ ! -f "MOAAgent/src/main/resources/application.yml" ] && [ ! -f "MOAServer/src/main/resources/application.yml" ]; then
    echo "‚ö†Ô∏è  Warning: No application.yml files found"
fi

# Check 2: Validate YAML syntax (if yq is available)
if command -v yq &> /dev/null; then
    echo "‚úì Validating YAML syntax..."
    for yml_file in $(find . -name "application*.yml" -not -path "*/build/*"); do
        yq eval . "$yml_file" > /dev/null 2>&1 || {
            echo "‚ùå Invalid YAML syntax in: $yml_file"
            exit 1
        }
    done
else
    echo "‚ö†Ô∏è  yq not found, skipping YAML validation"
fi

# Check 3: Ensure no hardcoded secrets
echo "üîí Checking for hardcoded secrets..."
SECRETS_PATTERN="(password|secret|api[_-]?key|token|credential).*[:=].*['\"][^'\"\$]"
if git diff --cached --name-only | grep -E '\.(yml|yaml|properties|java)$' | xargs grep -iE "$SECRETS_PATTERN" 2>/dev/null; then
    echo "‚ùå Potential hardcoded secrets found!"
    echo "   Please use environment variables or secrets management"
    exit 1
fi

# Check 4: Run Java formatting check (if spotless is configured)
if [ -f "build.gradle" ]; then
    echo "üé® Checking code formatting..."
    ./gradlew spotlessCheck 2>/dev/null || echo "‚ö†Ô∏è  Spotless not configured, skipping format check"
fi

# Check 5: Verify observability collector configuration
echo "üìä Validating observability configuration..."
if [ -f ".claude/settings/observability-config.json" ]; then
    # Check if at least one collector is enabled
    if ! grep -q '"enabled": true' .claude/settings/observability-config.json; then
        echo "‚ö†Ô∏è  Warning: No collectors enabled in observability-config.json"
    fi
fi

# Check 6: Ensure Git commit message doesn't contain Claude Code signature (per CLAUDE.md)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    if grep -q "Generated with \[Claude Code\]" "$COMMIT_MSG_FILE" || grep -q "Co-Authored-By: Claude" "$COMMIT_MSG_FILE"; then
        echo "‚ùå Commit message contains Claude Code signature!"
        echo "   Removing as per CLAUDE.md requirements..."
        sed -i.bak '/Generated with \[Claude Code\]/d' "$COMMIT_MSG_FILE"
        sed -i.bak '/Co-Authored-By: Claude/d' "$COMMIT_MSG_FILE"
        sed -i.bak '/^[[:space:]]*$/d' "$COMMIT_MSG_FILE"
        rm -f "$COMMIT_MSG_FILE.bak"
    fi
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
