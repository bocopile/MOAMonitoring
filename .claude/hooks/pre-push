#!/bin/bash
# Pre-push hook for MOAO11y Observability Framework
# Runs tests and quality checks before pushing

set -e

echo "ğŸš€ Running pre-push checks for MOAO11y..."

# Check 1: Run all tests
echo "ğŸ§ª Running tests..."
if [ -f "gradlew" ]; then
    ./gradlew test --no-daemon || {
        echo "âŒ Tests failed! Please fix before pushing."
        exit 1
    }
    echo "âœ… All tests passed!"
else
    echo "âš ï¸  gradlew not found, skipping tests"
fi

# Check 2: Check test coverage (if JaCoCo is configured)
echo "ğŸ“Š Checking test coverage..."
if ./gradlew jacocoTestReport --no-daemon 2>/dev/null; then
    # Look for coverage reports
    for report in $(find . -path "*/build/reports/jacoco/test/html/index.html"); do
        echo "   Coverage report: $report"
    done
fi

# Check 3: Run security checks (if dependency-check is configured)
echo "ğŸ”’ Running security checks..."
./gradlew dependencyCheckAnalyze --no-daemon 2>/dev/null || echo "âš ï¸  Dependency check not configured"

# Check 4: Verify build succeeds
echo "ğŸ—ï¸  Building project..."
./gradlew build -x test --no-daemon || {
    echo "âŒ Build failed! Please fix before pushing."
    exit 1
}

echo "âœ… All pre-push checks passed! Ready to push."
exit 0
