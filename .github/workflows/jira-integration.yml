name: JIRA Integration

on:
  pull_request:
    types: [opened, closed, reopened]
  push:
    branches:
      - main
      - develop
  create:
    branches:
      - '**'

jobs:
  jira-transition:
    name: Update JIRA Status
    runs-on: ubuntu-latest

    steps:
      - name: Extract JIRA Issue Key
        id: extract
        run: |
          # Extract from branch name
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          JIRA_KEY=$(echo "$BRANCH_NAME" | grep -oE 'MOA-[0-9]+' || echo "")

          # If not in branch, try PR title
          if [ -z "$JIRA_KEY" ] && [ -n "${{ github.event.pull_request.title }}" ]; then
            JIRA_KEY=$(echo "${{ github.event.pull_request.title }}" | grep -oE 'MOA-[0-9]+' || echo "")
          fi

          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "Found JIRA key: $JIRA_KEY"

      - name: Transition on Branch Create
        if: github.event_name == 'create' && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          transition: "In Progress"
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition on PR Open
        if: github.event.action == 'opened' && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          transition: "Code Review"
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Add PR Comment to JIRA
        if: github.event.action == 'opened' && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          comment: |
            Pull Request opened: #${{ github.event.pull_request.number }}
            Title: ${{ github.event.pull_request.title }}
            Author: ${{ github.event.pull_request.user.login }}
            Link: ${{ github.event.pull_request.html_url }}
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition on PR Merge
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          transition: "Testing"
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Add Merge Comment to JIRA
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          comment: |
            ✅ Pull Request merged to ${{ github.event.pull_request.base.ref }}
            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
            Merged by: ${{ github.event.pull_request.merged_by.login }}
            Merge commit: ${{ github.event.pull_request.merge_commit_sha }}
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition on PR Close (not merged)
        if: github.event.action == 'closed' && github.event.pull_request.merged == false && steps.extract.outputs.jira_key != ''
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          comment: |
            ⚠️ Pull Request closed without merging
            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
        env:
          JIRA_BASE_URL: https://gjrjr4545.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

  validate-jira-reference:
    name: Validate JIRA Reference
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR Title for JIRA Key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="${{ github.head_ref }}"

          if echo "$PR_TITLE" | grep -qE '\[?MOA-[0-9]+\]?'; then
            echo "✅ JIRA ticket found in PR title: $PR_TITLE"
            exit 0
          elif echo "$BRANCH_NAME" | grep -qE 'MOA-[0-9]+'; then
            echo "✅ JIRA ticket found in branch name: $BRANCH_NAME"
            exit 0
          else
            echo "❌ No JIRA ticket reference found in PR title or branch name"
            echo "Please include JIRA ticket (e.g., [MOA-123]) in PR title or branch name"
            exit 1
          fi
